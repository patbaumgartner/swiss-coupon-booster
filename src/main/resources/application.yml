application:
  version: "@project.version@"

spring:
  application:
    name: coupon-booster
  config:
    import:
      - "optional:file:../.env[.properties]"
      - "optional:file:.env[.properties]"
  main:
    web-application-type: none
    banner-mode: console
  threads:
    virtual:
      enabled: true

logging:
  level:
    org.springframework: INFO
    com.microsoft.playwright: INFO
    com.patbaumgartner: DEBUG
    root: INFO

coop:
  login:
    enabled: true

  user:
    email: "${COOP_USER_EMAIL:}"
    password: "${COOP_USER_PASSWORD:}"

  playwright:
    login-url: "https://www.supercard.ch/content/supercard/de.html?sso-check=1"
    # Provide a Netscape format cookies.txt file (e.g., exported from curl or browser)
    # Optional: Only needed for initial authentication if stealth measures fail
    cookies-file-path: "${COOP_COOKIES_FILE_PATH:}"
    typing-delay-ms: 100
    slow-mo-ms: 1000
    headless: false
    chrome-args:
      # CRITICAL for hiding automation
      - "--disable-blink-features=AutomationControlled"
      # Better approach - don't disable security completely
      - "--disable-features=IsolateOrigins,site-per-process,VizDisplayCompositor"
      - "--disable-site-isolation-trials"
      - "--disable-dev-shm-usage"
      - "--no-first-run"
      - "--no-default-browser-check"
      - "--disable-infobars"
      - "--window-size=1920,1080"
      # Exclude automation switches that can leak
      - "--exclude-switches=enable-automation"
      - "--disable-blink-features=AutomationControlled"
      # Add realistic window position
      - "--window-position=0,0"
      # Use default user agent (don't override via args - let context handle it)
    timeout-ms: 20000
    # Directory to store browser user data (cookies, local storage) for persistent sessions
    # Set this to enable persistent context and avoid repeated captchas
    user-data-dir: "${COOP_PLAYWRIGHT_USER_DATA_DIR:playwright-user-data}"

  selectors:
    cookie-accept-button: '[data-testid="uc-accept-all-button"]'
    login-link: "#a-accountLogin-desktop"
    username-input: "#username"
    password-input: "#password"
    submit-button: "#btnSubmit"

supercard:
  urls:
    base-url: "https://www.supercard.ch"
    config-url: "https://www.supercard.ch/bin/coop/supercard/oidc/pwa/configs.json"
    config-url-referer: "https://www.supercard.ch/de/app-digitale-services/digitale-bons.html"
    coupons-url: "https://webapi.supercard.ch/digital-coupons/api/v1/protected/dc?pageSize=9999&language=de"
    coupons-activation-url: "https://webapi.supercard.ch/digital-coupons/api/v1/protected/dc/action/activate?language=de"
    coupons-deactivation-url: "https://webapi.supercard.ch/digital-coupons/api/v1/protected/dc/action/deactivate?language=de"
  coupon-filter:
    include-product-types:
      - "39" # Aktuelles Bonheft
      - "01" # Bio, Nachhaltigkeit
      - "07" # Brot, Backwaren
      - "09" # Fertiggerichte, Tiefkühlprodukte
      - "04" # Fleisch, Fisch
      - "03" # Früchte, Gemüse
      - "05" # Getränke, nicht alkoholisch
      - "14" # Haushalt, Küche, Wohnen
      - "02" # Milchprodukte, Eier
      - "08" # Snacks, Süsses
      - "40" # Super Bons
      - "31" # Treibstoff, Fahrzeugbedarf
      - "36" # Vorräte

migros:
  login:
    enabled: true

  user:
    email: "${MIGROS_USER_EMAIL:}"
    password: "${MIGROS_USER_PASSWORD:}"

  playwright:
    login-url: "https://login.migros.ch/"
    password-url: "https://login.migros.ch/login/password"
    typing-delay-ms: 50
    slow-mo-ms: 500
    headless: false
    chrome-args:
      - "--no-sandbox"
      - "--disable-web-security"
      - "--disable-features=VizDisplayCompositor,WebAuthenticationAPI"
      - "--disable-blink-features=WebAuthenticationAPI"
    timeout-ms: 15000

  selectors:
    email-input: "#input-email"
    password-input: "#input-password"
    submit-button: "#button-submit"
    password-login-link: "#link-login-option-PASSWORD"
    cookie-accept-button: "button:has-text('Accept'), button:has-text('Akzeptieren')"

cumulus:
  urls:
    base-url: "https://account.migros.ch"
    coupons-endpoint: "${cumulus.urls.base-url}/ma/api/user/cumulus/coupon"
    coupons-referer: "${cumulus.urls.base-url}/cumulus/dashboard"
    activation-endpoint: "${cumulus.urls.base-url}/ma/api/user/cumulus/coupon/activation"

  api:
    request-delay: "PT0.5S"
    max-retries: 3
    timeout: "PT30S"
